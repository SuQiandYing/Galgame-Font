import os
import json
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel,
                             QTextEdit, QFrame, QLineEdit, QComboBox, QCheckBox,
                             QGridLayout, QScrollArea, QTableWidget, QTableWidgetItem,
                             QHeaderView, QSizePolicy, QSplitter, QStackedWidget)
from PyQt6.QtCore import Qt
from PyQt6.QtGui import QFont

from .widgets import IOSInput, IOSButton
from config import HAS_BROTLI

def setup_image_font_ui(main_window, parent_widget):
    """ç»Ÿä¸€çš„å›¾ç‰‡å­—åº“ç”Ÿæˆç•Œé¢ï¼Œé€šè¿‡ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸åŒæ¨¡å¼"""
    l = QVBoxLayout(parent_widget)
    
    main_window.lbl_imgfont = QLabel("å›¾ç‰‡å­—åº“ç”Ÿæˆ")
    main_window.lbl_imgfont.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_imgfont.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l.addWidget(main_window.lbl_imgfont)
    
    mode_layout = QHBoxLayout()
    mode_layout.addWidget(QLabel("ç”Ÿæˆæ¨¡å¼:"))
    main_window.imgfont_mode = QComboBox()
    main_window.imgfont_mode.addItems([
        "ğŸ“· PNG/WebP å›¾ç‰‡å­—åº“",
        "ğŸ® TGA å­—åº“ (æ¸¸æˆå¼•æ“)",
        "ğŸ–¼ï¸ BMP å­—åº“ (ä½å›¾)",
        "ğŸ“ BMFont (FNTæ ¼å¼)"
    ])
    main_window.imgfont_mode.setFixedHeight(38)
    main_window.imgfont_mode.currentIndexChanged.connect(lambda idx: main_window.imgfont_stack.setCurrentIndex(idx))
    mode_layout.addWidget(main_window.imgfont_mode)
    l.addLayout(mode_layout)
    
    line = QFrame()
    line.setFrameShape(QFrame.Shape.HLine)
    line.setStyleSheet("background: rgba(0,0,0,0.1);")
    l.addWidget(line)
    
    main_window.imgfont_stack = QStackedWidget()
    
    # === æ¨¡å¼ 0: PNG/WebP å›¾ç‰‡å­—åº“ ===
    p_pic = QWidget()
    l_pic = QVBoxLayout(p_pic)
    l_pic.setContentsMargins(0, 10, 0, 0)
    gd_pic = QGridLayout()
    gd_pic.setSpacing(10)
    main_window.pic_font = IOSInput("è¾“å…¥å­—ä½“è·¯å¾„", "game.ttf")
    main_window.pic_font.setToolTip("ç”¨äºç”Ÿæˆå›¾ç‰‡çš„æºå­—ä½“")
    btn_pic_font = QPushButton("ğŸ“")
    btn_pic_font.setFixedSize(40, 38)
    main_window.pic_folder = IOSInput("ä¿å­˜ç›®å½•", "image38")
    main_window.pic_folder.setToolTip("ç”Ÿæˆçš„å›¾ç‰‡å°†ä¿å­˜åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹")
    main_window.pic_fmt = IOSInput("æ‰©å±•å (å¦‚ webp)", "webp")
    main_window.pic_fmt.setToolTip("å›¾ç‰‡æ ¼å¼ï¼špng æˆ– webp")
    gd_pic.addWidget(QLabel("ä½¿ç”¨å­—ä½“:"), 0, 0)
    gd_pic.addLayout(main_window.create_file_row(main_window.pic_font, btn_pic_font), 0, 1)
    gd_pic.addWidget(QLabel("ä¿å­˜ç›®å½•:"), 1, 0)
    gd_pic.addWidget(main_window.pic_folder, 1, 1)
    gd_pic.addWidget(QLabel("å›¾ç‰‡æ ¼å¼:"), 2, 0)
    gd_pic.addWidget(main_window.pic_fmt, 2, 1)
    main_window.pic_fs = IOSInput("38", "38")
    main_window.pic_fs.setToolTip("å­—ä½“æ¸²æŸ“å¤§å°")
    main_window.pic_cnt = IOSInput("19", "19")
    main_window.pic_cnt.setToolTip("æ¯è¡ŒåŒ…å«å¤šå°‘ä¸ªå­—ç¬¦")
    gd_pic.addWidget(QLabel("å­—ä½“å¤§å°(px):"), 0, 2)
    gd_pic.addWidget(main_window.pic_fs, 0, 3)
    gd_pic.addWidget(QLabel("æ¯è¡Œå­—ç¬¦æ•°:"), 1, 2)
    gd_pic.addWidget(main_window.pic_cnt, 1, 3)
    main_window.pic_cw = IOSInput("W", "38")
    main_window.pic_ch = IOSInput("H", "38")
    main_window.pic_iw = IOSInput("IX", "10")
    main_window.pic_ih = IOSInput("Y", "10")
    gd_pic.addWidget(QLabel("å•å­—ç¬¦å®½é«˜:"), 2, 2)
    box_wh = QHBoxLayout()
    box_wh.addWidget(main_window.pic_cw)
    box_wh.addWidget(main_window.pic_ch)
    gd_pic.addLayout(box_wh, 2, 3)
    gd_pic.addWidget(QLabel("é—´è·/è¡Œè·:"), 3, 2)
    box_int = QHBoxLayout()
    box_int.addWidget(main_window.pic_iw)
    box_int.addWidget(main_window.pic_ih)
    gd_pic.addLayout(box_int, 3, 3)
    main_window.pic_imw = IOSInput("W", "1024")
    main_window.pic_imh = IOSInput("H", "640")
    main_window.pic_ix = IOSInput("X", "10")
    main_window.pic_iy = IOSInput("Y", "12")
    gd_pic.addWidget(QLabel("å•å›¾æ€»å°ºå¯¸:"), 4, 0)
    box_im = QHBoxLayout()
    box_im.addWidget(main_window.pic_imw)
    box_im.addWidget(main_window.pic_imh)
    gd_pic.addLayout(box_im, 4, 1)
    gd_pic.addWidget(QLabel("èµ·å§‹åç§»XY:"), 4, 2)
    box_xy = QHBoxLayout()
    box_xy.addWidget(main_window.pic_ix)
    box_xy.addWidget(main_window.pic_iy)
    gd_pic.addLayout(box_xy, 4, 3)
    l_pic.addLayout(gd_pic)
    l_pic.addStretch()
    main_window.imgfont_stack.addWidget(p_pic)
    
    # === æ¨¡å¼ 1: TGA å­—åº“ ===
    p_tga = QWidget()
    l_tga = QVBoxLayout(p_tga)
    l_tga.setContentsMargins(0, 10, 0, 0)
    gd_tga = QGridLayout()
    main_window.tga_font = IOSInput("è¾“å…¥å­—ä½“", "game.ttf")
    btn_tga_font = QPushButton("ğŸ“")
    btn_tga_font.setFixedSize(40, 38)
    main_window.tga_dat = IOSInput("DATæ–‡ä»¶å", "text")
    main_window.tga_dat.setToolTip("ç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶åï¼Œä¸å«åç¼€")
    main_window.tga_eng_n = IOSInput("å¼•æ“å†…å­—ä½“å", "M+ 1c")
    main_window.tga_eng_n.setToolTip("æ¸¸æˆå¼•æ“å†…éƒ¨è¯†åˆ«çš„å­—ä½“åç§°")
    main_window.tga_eng_p = IOSInput("è™šæ‹Ÿè·¯å¾„", "IMG/text.tga")
    main_window.tga_eng_p.setToolTip("æ¸¸æˆå†…éƒ¨è¯»å–çº¹ç†çš„è™šæ‹Ÿè·¯å¾„")
    gd_tga.addWidget(QLabel("å­—ä½“è·¯å¾„:"), 0, 0)
    gd_tga.addLayout(main_window.create_file_row(main_window.tga_font, btn_tga_font), 0, 1)
    gd_tga.addWidget(QLabel("ç´¢å¼•æ–‡ä»¶å:"), 1, 0)
    gd_tga.addWidget(main_window.tga_dat, 1, 1)
    gd_tga.addWidget(QLabel("å†…éƒ¨è¯†åˆ«å:"), 2, 0)
    gd_tga.addWidget(main_window.tga_eng_n, 2, 1)
    gd_tga.addWidget(QLabel("æ¸¸æˆå†…è·¯å¾„:"), 3, 0)
    gd_tga.addWidget(main_window.tga_eng_p, 3, 1)
    main_window.tga_fs = IOSInput("", "22")
    main_window.tga_cw = IOSInput("W", "24")
    main_window.tga_ch = IOSInput("H", "24")
    main_window.tga_iw = IOSInput("X", "1")
    main_window.tga_ih = IOSInput("Y", "0")
    main_window.tga_w = IOSInput("W", "1024")
    main_window.tga_h = IOSInput("H", "4096")
    gd_tga.addWidget(QLabel("å­—å·:"), 0, 2)
    gd_tga.addWidget(main_window.tga_fs, 0, 3)
    gd_tga.addWidget(QLabel("å•å­—å®½é«˜:"), 1, 2)
    box_twh = QHBoxLayout()
    box_twh.addWidget(main_window.tga_cw)
    box_twh.addWidget(main_window.tga_ch)
    gd_tga.addLayout(box_twh, 1, 3)
    gd_tga.addWidget(QLabel("é—´è·åç§»:"), 2, 2)
    box_ti = QHBoxLayout()
    box_ti.addWidget(main_window.tga_iw)
    box_ti.addWidget(main_window.tga_ih)
    gd_tga.addLayout(box_ti, 2, 3)
    gd_tga.addWidget(QLabel("å›¾é›†å°ºå¯¸:"), 3, 2)
    box_tim = QHBoxLayout()
    box_tim.addWidget(main_window.tga_w)
    box_tim.addWidget(main_window.tga_h)
    gd_tga.addLayout(box_tim, 3, 3)
    l_tga.addLayout(gd_tga)
    l_tga.addStretch()
    main_window.imgfont_stack.addWidget(p_tga)
    
    # === æ¨¡å¼ 2: BMP å­—åº“ ===
    p_bmp = QWidget()
    l_bmp = QVBoxLayout(p_bmp)
    l_bmp.setContentsMargins(0, 10, 0, 0)
    gd_bmp = QGridLayout()
    main_window.bmp_font = IOSInput("è¾“å…¥å­—ä½“", "game.ttf")
    btn_bmp_font = QPushButton("ğŸ“")
    btn_bmp_font.setFixedSize(40, 38)
    main_window.bmp_fs = IOSInput("Size", "60")
    main_window.bmp_sz = IOSInput("WxH", "64")
    main_window.bmp_cnt = IOSInput("Count", "16")
    main_window.bmp_w = IOSInput("Width", "1024")
    main_window.bmp_scale = IOSInput("Scale", "1.0")
    main_window.bmp_depth = IOSInput("Depth", "32")
    gd_bmp.addWidget(QLabel("å­—ä½“è·¯å¾„:"), 0, 0)
    gd_bmp.addLayout(main_window.create_file_row(main_window.bmp_font, btn_bmp_font), 0, 1)
    gd_bmp.addWidget(QLabel("å­—å·(pt/px):"), 1, 0)
    gd_bmp.addWidget(main_window.bmp_fs, 1, 1)
    gd_bmp.addWidget(QLabel("å•å­—æ ¼å¤§å°:"), 2, 0)
    gd_bmp.addWidget(main_window.bmp_sz, 2, 1)
    gd_bmp.addWidget(QLabel("æ¯è¡Œå­—æ•°:"), 3, 0)
    gd_bmp.addWidget(main_window.bmp_cnt, 3, 1)
    gd_bmp.addWidget(QLabel("çº¹ç†å®½åº¦:"), 4, 0)
    gd_bmp.addWidget(main_window.bmp_w, 4, 1)
    gd_bmp.addWidget(QLabel("ç¼©æ”¾å€ç‡:"), 5, 0)
    gd_bmp.addWidget(main_window.bmp_scale, 5, 1)
    gd_bmp.addWidget(QLabel("é¢œè‰²ä½æ·±:"), 6, 0)
    gd_bmp.addWidget(main_window.bmp_depth, 6, 1)
    l_bmp.addLayout(gd_bmp)
    l_bmp.addStretch()
    main_window.imgfont_stack.addWidget(p_bmp)
    
    # === æ¨¡å¼ 3: BMFont ===
    p_bmfont = QWidget()
    l_bmfont = QVBoxLayout(p_bmfont)
    l_bmfont.setContentsMargins(0, 10, 0, 0)
    gd_bm = QGridLayout()
    gd_bm.setSpacing(10)
    main_window.bm_font = IOSInput("è¯·æ‹–å…¥å­—ä½“æ–‡ä»¶", "game.ttf")
    main_window.bm_char_txt = IOSInput("è¯·æ‹–å…¥åŒ…å«æ‰€éœ€å­—ç¬¦çš„æ–‡æœ¬æ–‡ä»¶ (.txt)", "chars.txt")
    main_window.bm_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "font.fnt")
    main_window.bm_size = IOSInput("å­—ä½“å¤§å° (pt)", "32")
    main_window.bm_tex_size = QComboBox()
    main_window.bm_tex_size.addItems(["512", "1024", "2048", "4096"])
    main_window.bm_tex_size.setCurrentIndex(1)
    main_window.bm_tex_size.setFixedHeight(38)
    btn_font = QPushButton("ğŸ“"); btn_font.setFixedSize(40, 38)
    btn_txt = QPushButton("ğŸ“"); btn_txt.setFixedSize(40, 38); btn_txt.clicked.connect(lambda: main_window.browse_folder(main_window.bm_char_txt))
    gd_bm.addWidget(QLabel("è¾“å…¥å­—ä½“:"), 0, 0)
    gd_bm.addLayout(main_window.create_file_row(main_window.bm_font, btn_font), 0, 1)
    gd_bm.addWidget(QLabel("å­—ç¬¦æ¥æº:"), 1, 0)
    l_txt = QHBoxLayout()
    l_txt.addWidget(main_window.bm_char_txt)
    l_txt.addWidget(btn_txt)
    gd_bm.addLayout(l_txt, 1, 1)
    gd_bm.addWidget(QLabel("è¾“å‡ºæ–‡ä»¶:"), 2, 0)
    gd_bm.addWidget(main_window.bm_out, 2, 1)
    gd_bm.addWidget(QLabel("å­—ä½“å¤§å°:"), 3, 0)
    gd_bm.addWidget(main_window.bm_size, 3, 1)
    gd_bm.addWidget(QLabel("çº¹ç†å°ºå¯¸:"), 4, 0)
    gd_bm.addWidget(main_window.bm_tex_size, 4, 1)
    l_bmfont.addLayout(gd_bm)
    info_bm = QLabel(
        "<b>BMFont æ ¼å¼ç”¨é€”ï¼š</b><br>"
        "é’ˆå¯¹æ ‡å‡†ä½å›¾å­—ä½“æ ¼å¼çš„å¼•æ“ã€‚<br>"
        "å­—ç¬¦æ¥æºæ”¯æŒ .txt æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ (å°†è‡ªåŠ¨æ‰«æåŒ…å«çš„æ–‡æœ¬)"
    )
    info_bm.setStyleSheet("background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 11px;")
    l_bmfont.addWidget(info_bm)
    l_bmfont.addStretch()
    main_window.imgfont_stack.addWidget(p_bmfont)
    
    l.addWidget(main_window.imgfont_stack)
    l.addStretch()
    
    main_window.btn_run_imgfont = IOSButton("å¼€å§‹ç”Ÿæˆ")
    main_window.btn_run_imgfont.clicked.connect(main_window.do_gen_imgfont)
    l.addWidget(main_window.btn_run_imgfont)

def setup_mapping_manager_ui(main_window, parent_widget):
    main_layout = QHBoxLayout(parent_widget)
    splitter = QSplitter(Qt.Orientation.Horizontal)
    
    left_panel = QWidget()
    l_map = QVBoxLayout(left_panel)
    l_map.setContentsMargins(0, 0, 10, 0)
    main_window.lbl_map = QLabel("æ˜ å°„è¡¨ç”Ÿæˆ")
    main_window.lbl_map.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_map.setFont(QFont("Microsoft YaHei", 12, QFont.Weight.Bold))
    l_map.addWidget(main_window.lbl_map)
    gd_map = QGridLayout()
    main_window.map_src = IOSInput("é€‰æ‹©åŒ…å«ç¿»è¯‘æ–‡æœ¬çš„ç›®å½•", "cn_text")
    main_window.map_src.setToolTip("è¯·ç›´æ¥æ‹–å…¥æ–‡ä»¶å¤¹åˆ°æ­¤è¾“å…¥æ¡†ï¼Œæˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰æ‹©")
    main_window.btn_map_src = QPushButton("ğŸ“")
    main_window.btn_map_src.setFixedSize(40, 38)
    main_window.btn_map_src.clicked.connect(lambda: main_window.browse_folder(main_window.map_src))
    main_window.map_out = IOSInput("æ›¿æ¢åæ–‡æœ¬ä¿å­˜ç›®å½•", "cn_text_mapped")
    main_window.map_json = IOSInput("è¾“å‡ºçš„JSONæ–‡ä»¶å", "custom_map.json")
    main_window.map_ext = IOSInput("txt; json", "txt; json")
    main_window.map_limit_font = IOSInput("å¯é€‰ï¼šé™åˆ¶æ˜ å°„èŒƒå›´çš„å­—ä½“", "")
    main_window.map_limit_font.setToolTip("åªæ˜ å°„åˆ°è¯¥å­—ä½“ä¸­å­˜åœ¨çš„å­—ç¬¦ä¸Š")
    btn_limit_font = QPushButton("ğŸ“")
    btn_limit_font.setFixedSize(40, 38)
    gd_map.addWidget(QLabel("è¾“å…¥æ–‡æœ¬ç›®å½•:"), 0, 0)
    box_ms = QHBoxLayout()
    box_ms.addWidget(main_window.map_src)
    box_ms.addWidget(main_window.btn_map_src)
    gd_map.addLayout(box_ms, 0, 1)
    gd_map.addWidget(QLabel("è¾“å‡ºæ–‡æœ¬ç›®å½•:"), 1, 0)
    gd_map.addWidget(main_window.map_out, 1, 1)
    gd_map.addWidget(QLabel("è¾“å‡ºç è¡¨è·¯å¾„:"), 2, 0)
    gd_map.addWidget(main_window.map_json, 2, 1)
    gd_map.addWidget(QLabel("æ‰«ææ–‡ä»¶ç±»å‹:"), 3, 0)
    gd_map.addWidget(main_window.map_ext, 3, 1)
    gd_map.addWidget(QLabel("é™åˆ¶å­—ä½“(é€‰):"), 4, 0)
    gd_map.addLayout(main_window.create_file_row(main_window.map_limit_font, btn_limit_font), 4, 1)
    l_map.addLayout(gd_map)
    info_txt = QLabel("å°†åŒ…å«ç¿»è¯‘æ–‡æœ¬çš„æ–‡ä»¶å¤¹ç›´æ¥æ‹–å…¥ä¸Šæ–¹è¾“å…¥æ¡†å³å¯")
    info_txt.setStyleSheet("color: gray; font-size: 11px;")
    l_map.addWidget(info_txt)
    main_window.btn_run_map = IOSButton("æ‰«æå¹¶ç”Ÿæˆæ˜ å°„")
    main_window.btn_run_map.clicked.connect(main_window.do_gen_map)
    main_window.btn_checkup_map = IOSButton("æ£€æŸ¥ç¼ºå­—")
    main_window.btn_checkup_map.clicked.connect(lambda: main_window.do_checkup('map'))
    main_window.btn_preview_map = IOSButton("é¢„è§ˆæ›¿æ¢")
    main_window.btn_preview_map.clicked.connect(main_window.do_preview_mapping)
    l_map.addStretch()
    btn_row_map = QHBoxLayout()
    btn_row_map.addWidget(main_window.btn_run_map)
    btn_row_map.addWidget(main_window.btn_preview_map)
    btn_row_map.addWidget(main_window.btn_checkup_map)
    l_map.addLayout(btn_row_map)
    
    right_panel = QWidget()
    l_edit = QVBoxLayout(right_panel)
    l_edit.setContentsMargins(10, 0, 0, 0)
    main_window.lbl_ed = QLabel("æ˜ å°„è¡¨ç¼–è¾‘å™¨")
    main_window.lbl_ed.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_ed.setFont(QFont("Microsoft YaHei", 12, QFont.Weight.Bold))
    l_edit.addWidget(main_window.lbl_ed)
    top_bar = QHBoxLayout()
    btn_load = QPushButton("è¯»å–JSON")
    btn_load.clicked.connect(main_window.load_json_to_table)
    btn_save = QPushButton("ä¿å­˜JSON")
    btn_save.clicked.connect(main_window.save_table_to_json)
    top_bar.addWidget(btn_load)
    top_bar.addWidget(btn_save)
    l_edit.addLayout(top_bar)
    main_window.map_table = QTableWidget()
    main_window.map_table.setColumnCount(3)
    main_window.map_table.setHorizontalHeaderLabels(["åŸæ–‡ (CN)", "æ˜ å°„ (CP932)", "å¤‡æ³¨"])
    header = main_window.map_table.horizontalHeader()
    header.setSectionResizeMode(0, QHeaderView.ResizeMode.Stretch)
    header.setSectionResizeMode(1, QHeaderView.ResizeMode.Stretch)
    header.setSectionResizeMode(2, QHeaderView.ResizeMode.ResizeToContents)
    main_window.map_table.setAlternatingRowColors(True)
    l_edit.addWidget(main_window.map_table)
    bot_bar = QHBoxLayout()
    main_window.in_new_key = QLineEdit()
    main_window.in_new_key.setPlaceholderText("åŸæ–‡")
    main_window.in_new_val = QLineEdit()
    main_window.in_new_val.setPlaceholderText("æ˜ å°„å­—")
    btn_add = QPushButton("æ·»åŠ ")
    btn_add.clicked.connect(main_window.add_mapping_row)
    btn_del = QPushButton("åˆ é™¤é€‰ä¸­")
    btn_del.clicked.connect(main_window.remove_mapping_row)
    bot_bar.addWidget(main_window.in_new_key)
    bot_bar.addWidget(main_window.in_new_val)
    bot_bar.addWidget(btn_add)
    bot_bar.addWidget(btn_del)
    l_edit.addLayout(bot_bar)
    
    splitter.addWidget(left_panel)
    splitter.addWidget(right_panel)
    splitter.setStretchFactor(0, 1)
    splitter.setStretchFactor(1, 1)
    main_layout.addWidget(splitter)

def setup_font_analysis_ui(main_window, parent_widget):
    main_layout = QHBoxLayout(parent_widget)
    splitter = QSplitter(Qt.Orientation.Horizontal)
    
    left_panel = QWidget()
    l_cmp = QVBoxLayout(left_panel)
    l_cmp.setContentsMargins(0, 0, 10, 0)
    main_window.lbl_cmp = QLabel("å­—ç¬¦é›†å¯¹æ¯”")
    main_window.lbl_cmp.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_cmp.setFont(QFont("Microsoft YaHei", 12, QFont.Weight.Bold))
    l_cmp.addWidget(main_window.lbl_cmp)
    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.cmp_font1 = IOSInput("å­—ä½“ A", "fontA.ttf")
    main_window.cmp_font2 = IOSInput("å­—ä½“ B", "fontB.ttf")
    btn_cmp_font1 = QPushButton("ğŸ“")
    btn_cmp_font1.setFixedSize(40, 38)
    btn_cmp_font2 = QPushButton("ğŸ“")
    btn_cmp_font2.setFixedSize(40, 38)
    gd.addWidget(QLabel("å­—ä½“ A:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.cmp_font1, btn_cmp_font1), 0, 1)
    gd.addWidget(QLabel("å­—ä½“ B:"), 1, 0)
    gd.addLayout(main_window.create_file_row(main_window.cmp_font2, btn_cmp_font2), 1, 1)
    l_cmp.addLayout(gd)
    main_window.cmp_result = QTextEdit()
    main_window.cmp_result.setReadOnly(True)
    main_window.cmp_result.setStyleSheet("background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; font-family: 'Consolas', monospace;")
    main_window.cmp_result.setPlainText("ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å¯¹æ¯”...")
    l_cmp.addWidget(main_window.cmp_result)
    btn_row = QHBoxLayout()
    main_window.btn_run_compare = IOSButton("å¼€å§‹å¯¹æ¯”")
    main_window.btn_export_diff = IOSButton("å¯¼å‡ºå·®å¼‚")
    main_window.btn_run_compare.clicked.connect(main_window.do_compare_fonts)
    main_window.btn_export_diff.clicked.connect(main_window.do_export_diff)
    btn_row.addWidget(main_window.btn_run_compare)
    btn_row.addWidget(main_window.btn_export_diff)
    l_cmp.addLayout(btn_row)
    main_window._compare_result = {}
    
    right_panel = QWidget()
    l_cov = QVBoxLayout(right_panel)
    l_cov.setContentsMargins(10, 0, 0, 0)
    main_window.lbl_cov = QLabel("å­—ç¬¦è¦†ç›–ç‡åˆ†æ")
    main_window.lbl_cov.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_cov.setFont(QFont("Microsoft YaHei", 12, QFont.Weight.Bold))
    l_cov.addWidget(main_window.lbl_cov)
    gd_cov = QGridLayout()
    gd_cov.setSpacing(10)
    main_window.cov_font = IOSInput("è¯·æ‹–å…¥è¦åˆ†æçš„å­—ä½“", "game.ttf")
    btn_cov_font = QPushButton("ğŸ“")
    btn_cov_font.setFixedSize(40, 38)
    gd_cov.addWidget(QLabel("å­—ä½“æ–‡ä»¶:"), 0, 0)
    gd_cov.addLayout(main_window.create_file_row(main_window.cov_font, btn_cov_font), 0, 1)
    l_cov.addLayout(gd_cov)
    main_window.cov_result = QTextEdit()
    main_window.cov_result.setReadOnly(True)
    main_window.cov_result.setStyleSheet("background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; font-family: 'Consolas', monospace;")
    main_window.cov_result.setPlainText("ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ†æ...")
    l_cov.addWidget(main_window.cov_result)
    main_window.btn_run_coverage = IOSButton("åˆ†æè¦†ç›–ç‡")
    main_window.btn_run_coverage.clicked.connect(main_window.do_coverage_analysis)
    l_cov.addWidget(main_window.btn_run_coverage)
    
    splitter.addWidget(left_panel)
    splitter.addWidget(right_panel)
    splitter.setStretchFactor(0, 1)
    splitter.setStretchFactor(1, 1)
    main_layout.addWidget(splitter)

def setup_unified_fix_ui(main_window, parent_widget):
    l = QVBoxLayout(parent_widget)
    
    main_window.lbl_fix = QLabel("åº¦é‡ä¿®å¤") 
    main_window.lbl_fix.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_fix.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l.addWidget(main_window.lbl_fix)

    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.fix_src = IOSInput("æ‹–å…¥ç›®æ ‡å­—ä½“", "target.ttf")
    main_window.fix_ref = IOSInput("æ‹–å…¥å‚è€ƒå­—ä½“", "ref.ttf")
    main_window.fix_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "fixed.ttf")
    
    btn_src = QPushButton("ğŸ“")
    btn_src.setFixedSize(40, 38)
    btn_ref = QPushButton("ğŸ“")
    btn_ref.setFixedSize(40, 38)
    
    gd.addWidget(QLabel("1. ç›®æ ‡å­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.fix_src, btn_src), 0, 1)
    gd.addWidget(QLabel("2. å‚è€ƒå­—ä½“:"), 1, 0)
    gd.addLayout(main_window.create_file_row(main_window.fix_ref, btn_ref), 1, 1)
    gd.addWidget(QLabel("3. è¾“å‡ºæ–‡ä»¶:"), 2, 0)
    gd.addWidget(main_window.fix_out, 2, 1)
    l.addLayout(gd)

    line = QFrame(); line.setFrameShape(QFrame.Shape.HLine); line.setStyleSheet("background:rgba(0,0,0,0.1)")
    l.addWidget(line)

    l.addWidget(QLabel("<b>å­—å½¢è°ƒæ•´</b> (å¯é€‰)"))
    
    row_deform = QHBoxLayout()
    
    main_window.fix_scale_x = IOSInput("1.00", "1.00")
    main_window.fix_scale_y = IOSInput("1.00", "1.00")
    main_window.fix_spacing = IOSInput("0", "0")
    
    main_window.fix_scale_x.setToolTip("å®½åº¦å€ç‡ï¼šå°äº1å˜ç˜¦")
    main_window.fix_scale_y.setToolTip("é«˜åº¦å€ç‡ï¼šå°äº1å˜çŸ®")
    main_window.fix_spacing.setToolTip("é¢å¤–å­—é—´è·ï¼šåƒç´ å•ä½")

    row_deform.addWidget(QLabel("å­—å®½:"))
    row_deform.addWidget(main_window.fix_scale_x)
    row_deform.addSpacing(15)
    row_deform.addWidget(QLabel("å­—é«˜:"))
    row_deform.addWidget(main_window.fix_scale_y)
    row_deform.addSpacing(15)
    row_deform.addWidget(QLabel("å­—é—´è·:"))
    row_deform.addWidget(main_window.fix_spacing)
    
    l.addLayout(row_deform)
    l.addSpacing(5)

    tool_bar = QHBoxLayout()
    
    lbl_metrics = QLabel("<b>å‚ç›´åº¦é‡</b> (Asc/Desc)")
    lbl_metrics.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Preferred)
    tool_bar.addWidget(lbl_metrics)
    
    btn_auto = QPushButton("è‡ªåŠ¨è®¡ç®—")
    btn_auto.clicked.connect(main_window.read_unified_metrics)
    btn_auto.setCursor(Qt.CursorShape.PointingHandCursor)
    btn_auto.setFixedWidth(160)
    btn_auto.setStyleSheet("""
        QPushButton { 
            background-color: #E1F5FE; color: #0277BD; border: 1px solid #B3E5FC; 
            border-radius: 15px; padding: 4px; font-weight: bold;
        }
        QPushButton:hover { background-color: #81D4FA; color: white;}
    """)
    tool_bar.addWidget(btn_auto)
    
    l.addLayout(tool_bar)

    row_metrics = QHBoxLayout()
    
    main_window.fix_asc = IOSInput("ä¸Šè¡Œé«˜åº¦", "880")
    main_window.fix_desc = IOSInput("ä¸‹è¡Œé«˜åº¦", "-120")
    main_window.fix_gap = IOSInput("è¡Œé—´è·", "0")
    
    row_metrics.addWidget(QLabel("ä¸Šè¡Œé«˜åº¦:"))
    row_metrics.addWidget(main_window.fix_asc)
    row_metrics.addSpacing(10)
    row_metrics.addWidget(QLabel("ä¸‹è¡Œé«˜åº¦:"))
    row_metrics.addWidget(main_window.fix_desc)
    row_metrics.addSpacing(10)
    row_metrics.addWidget(QLabel("è¡Œé—´è·:"))
    row_metrics.addWidget(main_window.fix_gap)
    
    l.addLayout(row_metrics)
    
    l.addStretch()
    
    main_window.btn_do_fix = IOSButton("æ‰§è¡Œä¿®å¤")
    main_window.btn_do_fix.clicked.connect(main_window.do_unified_fix)
    l.addWidget(main_window.btn_do_fix)

def setup_metrics_ui(main_window, parent_widget):
    l_metrics = QVBoxLayout(parent_widget)
    main_window.lbl_met = QLabel("å­—ä½“å‚ç›´åº¦é‡ä¿®æ­£")
    main_window.lbl_met.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_met.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l_metrics.addWidget(main_window.lbl_met)

    gd_met = QGridLayout()
    gd_met.setSpacing(10)

    main_window.met_font_path = IOSInput("è¯·æ‹–å…¥å¾…ä¿®å¤å­—ä½“", "fixed.ttf")
    main_window.met_ref_path = IOSInput("å‚è€ƒå­—ä½“ (åŸç‰ˆJPå­—ä½“)", "original.ttf")

    main_window.in_ascender = IOSInput("Ascender (ä¸Šè¡Œ)", "880")
    main_window.in_descender = IOSInput("Descender (ä¸‹è¡Œ)", "-120")
    main_window.in_linegap = IOSInput("LineGap (è¡Œè·)", "0")

    btn_read_met = QPushButton("è¯»å–æ•°å€¼")
    btn_read_met.setFixedHeight(38)
    btn_read_met.clicked.connect(main_window.read_font_metrics)
    main_window.btn_apply_met = IOSButton("åº”ç”¨å¹¶ä¿å­˜")
    main_window.btn_apply_met.clicked.connect(main_window.apply_font_metrics)

    gd_met.addWidget(QLabel("ç›®æ ‡å­—ä½“:"), 0, 0)
    gd_met.addWidget(main_window.met_font_path, 0, 1)
    gd_met.addWidget(QLabel("å‚è€ƒå­—ä½“:"), 1, 0)
    gd_met.addWidget(main_window.met_ref_path, 1, 1)
    gd_met.addWidget(btn_read_met, 2, 0, 1, 2)

    gd_met.addWidget(QLabel("ä¸Šè¡Œé«˜åº¦"), 3, 0)
    gd_met.addWidget(main_window.in_ascender, 3, 1)
    gd_met.addWidget(QLabel("ä¸‹è¡Œé«˜åº¦:"), 4, 0)
    gd_met.addWidget(main_window.in_descender, 4, 1)
    gd_met.addWidget(QLabel("è¡Œé—´è·"), 5, 0)
    gd_met.addWidget(main_window.in_linegap, 5, 1)

    l_metrics.addLayout(gd_met)
    l_metrics.addWidget(QLabel("ç”¨äºè§£å†³ç¿»è¯‘åæ–‡å­—åœ¨æ¸¸æˆä¸­åä¸Šã€åä¸‹æˆ–è¢«æˆªæ–­çš„é—®é¢˜"))
    l_metrics.addStretch()
    l_metrics.addWidget(main_window.btn_apply_met)

def setup_subset_ui(main_window, parent_widget):
    l_sub = QVBoxLayout(parent_widget)
    main_window.lbl_sub = QLabel("ç²¾ç®€ç˜¦èº«")
    main_window.lbl_sub.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_sub.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l_sub.addWidget(main_window.lbl_sub)

    gd = QGridLayout()
    gd.setSpacing(10)

    main_window.sub_font = IOSInput("è¯·æ‹–å…¥æºå­—ä½“ (é€šå¸¸æ˜¯åŒ…å«2ä¸‡å­—çš„æ€æºé»‘ä½“)", "Source.ttf")
    main_window.sub_txt = IOSInput("æ–‡æœ¬ç›®å½• (ç”¨äºæ‰«æç”¨å­—)", "cn_text")
    main_window.sub_json = IOSInput("æ˜ å°„è¡¨ (å¯é€‰, ä¹Ÿä¼šè¢«åŒ…å«)", "custom_map.json")
    main_window.sub_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "game_subset.ttf")

    btn_scan_dir = QPushButton("ğŸ“")
    btn_scan_dir.setFixedSize(40, 38)
    btn_font = QPushButton("ğŸ“")
    btn_font.setFixedSize(40, 38)

    gd.addWidget(QLabel("1. æºå­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.sub_font, btn_font), 0, 1)
    gd.addWidget(QLabel("2. æ–‡æœ¬ç›®å½•:"), 1, 0)
    gd.addLayout(main_window.create_file_row(main_window.sub_txt, btn_scan_dir), 1, 1)
    gd.addWidget(QLabel("3. æ˜ å°„è¡¨(é€‰):"), 2, 0)
    gd.addWidget(main_window.sub_json, 2, 1)
    gd.addWidget(QLabel("4. è¾“å‡ºæ–‡ä»¶:"), 3, 0)
    gd.addWidget(main_window.sub_out, 3, 1)

    l_sub.addLayout(gd)

    info = QLabel("""
    <b>åŠŸèƒ½è¯´æ˜ï¼š</b><br>
    <font color='#2196F3'>å¼ºåˆ¶ä¿ç•™ï¼šASCII + æ—¥æ–‡å‡å + å¸¸ç”¨æ ‡ç‚¹</font><br>
    <font color='#4CAF50'>æ™ºèƒ½æ‰«æï¼šä»…ä¿ç•™æ–‡æœ¬ç›®å½•å’Œæ˜ å°„è¡¨ä¸­å‡ºç°è¿‡çš„æ±‰å­—å’Œç‰¹æ®Šç¬¦å·</font><br>
    <font color='#F44336'>è‡ªåŠ¨å‰”é™¤ï¼šæœªä½¿ç”¨çš„æ±‰å­—ã€éŸ©æ–‡ã€ç”Ÿåƒ»ç¬¦å·å°†è¢«åˆ é™¤</font><br>
    æ­¤æ¨¡å¼å¯æœ€å¤§ç¨‹åº¦å‡å°ä½“ç§¯ (å¦‚ 20MB -> 2~5MB)
    """)
    info.setStyleSheet("background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 12px;")
    l_sub.addWidget(info)

    l_sub.addStretch()

    main_window.btn_run_subset = IOSButton("å¼€å§‹ç²¾ç®€")
    main_window.btn_run_subset.clicked.connect(main_window.do_subset)
    main_window.btn_checkup_subset = IOSButton("æ£€æŸ¥ç¼ºå­—")
    main_window.btn_checkup_subset.clicked.connect(lambda: main_window.do_checkup('subset'))

    btn_row_sub = QHBoxLayout()
    btn_row_sub.addWidget(main_window.btn_run_subset)
    btn_row_sub.addWidget(main_window.btn_checkup_subset)
    l_sub.addLayout(btn_row_sub)

def setup_merge_ui(main_window, parent_widget):
    l_merge = QVBoxLayout(parent_widget)
    main_window.lbl_merge = QLabel("åˆå¹¶è¡¥å­—")
    main_window.lbl_merge.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_merge.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l_merge.addWidget(main_window.lbl_merge)

    gd = QGridLayout()
    gd.setSpacing(10)

    main_window.merge_base = IOSInput("åŸºç¡€å­—ä½“ (ç¼ºå­—çš„å­—ä½“)", "base.ttf")
    main_window.merge_add = IOSInput("æ¥æºå­—ä½“ (æœ‰å­—çš„å­—ä½“)", "source.ttf")
    main_window.merge_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "merged.ttf")
    main_window.merge_filter = IOSInput("å¯é€‰ï¼šä»…æ·»åŠ è¿™äº›å­—ç¬¦ (ç•™ç©ºåˆ™æ·»åŠ æ‰€æœ‰ç¼ºå­—)", "")
    main_window.merge_filter.setToolTip("åœ¨æ­¤è¾“å…¥æ‚¨æƒ³ä»æ¥æºå­—ä½“ä¸­æå–çš„å…·ä½“å­—ç¬¦ï¼ˆå¦‚'â™¥â˜…'ï¼‰ã€‚\nå¦‚æœä¸å¡«ï¼Œç¨‹åºä¼šè‡ªåŠ¨æŠŠæ¥æºå­—ä½“ä¸­æ‰€æœ‰åŸºç¡€å­—ä½“æ²¡æœ‰çš„å­—éƒ½è¡¥è¿›å»ã€‚")

    btn_merge_base = QPushButton("ğŸ“")
    btn_merge_base.setFixedSize(40, 38)
    btn_merge_add = QPushButton("ğŸ“")
    btn_merge_add.setFixedSize(40, 38)

    gd.addWidget(QLabel("1. åŸºç¡€å­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.merge_base, btn_merge_base), 0, 1)
    gd.addWidget(QLabel("2. æ¥æºå­—ä½“:"), 1, 0)
    gd.addLayout(main_window.create_file_row(main_window.merge_add, btn_merge_add), 1, 1)
    gd.addWidget(QLabel("3. è¾“å‡ºæ–‡ä»¶:"), 2, 0)
    gd.addWidget(main_window.merge_out, 2, 1)
    gd.addWidget(QLabel("4. æŒ‡å®šå­—ç¬¦:"), 3, 0)
    gd.addWidget(main_window.merge_filter, 3, 1)

    l_merge.addLayout(gd)

    info = QLabel("""
    <b>åŠŸèƒ½è¯´æ˜ï¼š</b><br>
    å°†<b>æ¥æºå­—ä½“</b>ä¸­çš„å­—å½¢åˆå¹¶åˆ°<b>åŸºç¡€å­—ä½“</b>ä¸­ã€‚<br>
    <font color='#2196F3'>åœºæ™¯ï¼šå­—ä½“1ç¼ºäº†å‡ ä¸ªå­—ï¼Œæƒ³ä»å­—ä½“2é‡Œæ‹¿è¿‡æ¥</font><br>
    <font color='#4CAF50'>ç”¨æ³•ï¼šåœ¨"æŒ‡å®šå­—ç¬¦"æ¡†ä¸­è¾“å…¥é‚£å‡ ä¸ªå­—ï¼Œç‚¹å‡»åˆå¹¶å³å¯</font>
    """)
    info.setStyleSheet("background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 12px;")
    l_merge.addWidget(info)

    l_merge.addStretch()

    main_window.btn_run_merge = IOSButton("å¼€å§‹åˆå¹¶")
    main_window.btn_run_merge.clicked.connect(main_window.do_merge_fonts)
    l_merge.addWidget(main_window.btn_run_merge)

def setup_info_ui(main_window, parent_widget):
    l_info = QVBoxLayout(parent_widget)
    
    main_window.lbl_info = QLabel("å­—ä½“ä¿¡æ¯ç¼–è¾‘")
    main_window.lbl_info.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_info.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l_info.addWidget(main_window.lbl_info)

    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.info_font = IOSInput("æ‹–å…¥å­—ä½“æ–‡ä»¶", "font.ttf")
    
    btn_browse = QPushButton("ğŸ“")
    btn_browse.setFixedSize(40, 38)
    
    gd.addWidget(QLabel("å­—ä½“æ–‡ä»¶:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.info_font, btn_browse), 0, 1)
    l_info.addLayout(gd)

    main_window.info_table = QTableWidget()
    main_window.info_table.setColumnCount(3)
    main_window.info_table.setHorizontalHeaderLabels(["ID", "å­—æ®µåç§°", "å†…å®¹ (åŒå‡»ä¿®æ”¹)"])
    
    header = main_window.info_table.horizontalHeader()
    header.setSectionResizeMode(0, QHeaderView.ResizeMode.ResizeToContents)
    header.setSectionResizeMode(1, QHeaderView.ResizeMode.ResizeToContents)
    header.setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)
    
    main_window.info_table.verticalHeader().setVisible(False)
    main_window.info_table.setAlternatingRowColors(True)
    
    l_info.addWidget(main_window.info_table)

    btn_row = QHBoxLayout()
    main_window.btn_read_info = IOSButton("è¯»å–ä¿¡æ¯")
    main_window.btn_save_info = IOSButton("ä¿å­˜ä¿®æ”¹")
    
    main_window.btn_read_info.clicked.connect(main_window.do_read_font_info)
    main_window.btn_save_info.clicked.connect(main_window.do_save_font_info)
    
    btn_row.addWidget(main_window.btn_read_info)
    btn_row.addWidget(main_window.btn_save_info)
    l_info.addLayout(btn_row)

def setup_compare_ui(main_window, parent_widget):
    l_cmp = QVBoxLayout(parent_widget)
    main_window.lbl_cmp = QLabel("å­—ç¬¦é›†å¯¹æ¯”")
    main_window.lbl_cmp.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_cmp.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l_cmp.addWidget(main_window.lbl_cmp)

    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.cmp_font1 = IOSInput("å­—ä½“ A", "fontA.ttf")
    main_window.cmp_font2 = IOSInput("å­—ä½“ B", "fontB.ttf")
    gd.addWidget(QLabel("å­—ä½“ A:"), 0, 0)
    gd.addWidget(main_window.cmp_font1, 0, 1)
    gd.addWidget(QLabel("å­—ä½“ B:"), 1, 0)
    gd.addWidget(main_window.cmp_font2, 1, 1)
    l_cmp.addLayout(gd)

    main_window.cmp_result = QTextEdit()
    main_window.cmp_result.setReadOnly(True)
    main_window.cmp_result.setStyleSheet("background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; font-family: 'Consolas', monospace;")
    main_window.cmp_result.setPlainText("ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å¯¹æ¯”...")
    l_cmp.addWidget(main_window.cmp_result)

    btn_row = QHBoxLayout()
    main_window.btn_run_compare = IOSButton("å¼€å§‹å¯¹æ¯”")
    main_window.btn_export_diff = IOSButton("å¯¼å‡ºå·®å¼‚")
    main_window.btn_run_compare.clicked.connect(main_window.do_compare_fonts)
    main_window.btn_export_diff.clicked.connect(main_window.do_export_diff)
    btn_row.addWidget(main_window.btn_run_compare)
    btn_row.addWidget(main_window.btn_export_diff)
    l_cmp.addLayout(btn_row)

    main_window._compare_result = {}

def setup_smart_fallback_ui(main_window, parent_widget):
    l_smart = QVBoxLayout(parent_widget)
    lbl = QLabel("æ™ºèƒ½è¡¥å­—")
    lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
    lbl.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    lbl.setStyleSheet(f"color: {main_window.theme['text_main']};")
    l_smart.addWidget(lbl)
    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.sf_primary = IOSInput("ä¸»å­—ä½“ (ç¼ºå­—çš„é‚£ä¸ª)", "game.ttf")
    btn_sf_primary = QPushButton("ğŸ“")
    btn_sf_primary.setFixedSize(40, 38)
    main_window.sf_txt = IOSInput("æ–‡æœ¬ç›®å½• (æ£€æŸ¥è¿™äº›æ–‡æœ¬é‡Œçš„å­—)", "cn_text")
    main_window.sf_lib = IOSInput("è¡¥å…¨åº“ç›®å½• (å­˜æ”¾å¾ˆå¤šå­—ä½“çš„æ–‡ä»¶å¤¹)", "fonts_library")
    btn_scan_txt = QPushButton("ğŸ“")
    btn_scan_txt.setFixedSize(40, 38)
    btn_scan_lib = QPushButton("ğŸ“")
    btn_scan_lib.setFixedSize(40, 38)
    gd.addWidget(QLabel("1. ä¸»å­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.sf_primary, btn_sf_primary), 0, 1)
    gd.addWidget(QLabel("2. æ–‡æœ¬æº:"), 1, 0)
    gd.addLayout(main_window.create_file_row(main_window.sf_txt, btn_scan_txt), 1, 1)
    gd.addWidget(QLabel("3. è¡¥å…¨åº“:"), 2, 0)
    gd.addLayout(main_window.create_file_row(main_window.sf_lib, btn_scan_lib), 2, 1)
    l_smart.addLayout(gd)
    main_window.sf_table = QTableWidget()
    main_window.sf_table.setColumnCount(3)
    main_window.sf_table.setHorizontalHeaderLabels(["ç¼ºå¤±å­—ç¬¦", "Unicode", "æ¨èæ¥æºå­—ä½“"])
    main_window.sf_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.ResizeMode.Stretch)
    l_smart.addWidget(main_window.sf_table)
    btn_box = QHBoxLayout()
    main_window.btn_run_smart = IOSButton("å¼€å§‹åˆ†æ")
    main_window.btn_run_smart.clicked.connect(main_window.do_smart_fallback_scan)
    main_window.btn_export_smart = QPushButton("å¯¼å‡ºè¡¥å…¨æ¸…å•")
    main_window.btn_export_smart.setFixedHeight(45)
    main_window.btn_export_smart.clicked.connect(main_window.export_smart_result)
    btn_box.addWidget(main_window.btn_run_smart)
    btn_box.addWidget(main_window.btn_export_smart)
    l_smart.addLayout(btn_box)
    hint = QLabel("å·¥å…·ä¼šæ‰«æåº“ä¸­æ‰€æœ‰å­—ä½“ï¼Œä¼˜å…ˆæ¨èåŒ…å«ç¼ºå­—æ•°é‡æœ€å¤šçš„é‚£ä¸ª")
    hint.setStyleSheet("color: gray; font-size: 11px;")
    l_smart.addWidget(hint)

def setup_woff2_ui(main_window, parent_widget):
    l = QVBoxLayout(parent_widget)
    main_window.lbl_woff2 = QLabel("Webè½¬æ¢")
    main_window.lbl_woff2.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_woff2.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l.addWidget(main_window.lbl_woff2)

    if not HAS_BROTLI:
        warn = QLabel("æœªå®‰è£… brotli æ¨¡å—ï¼Œæ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚\nè¯·åœ¨ç»ˆç«¯è¿è¡Œ: pip install brotli")
        warn.setStyleSheet("color: red; padding: 20px; font-size: 14px; background: rgba(255,0,0,0.1); border-radius: 10px;")
        warn.setAlignment(Qt.AlignmentFlag.AlignCenter)
        l.addWidget(warn)
        l.addStretch()
        return

    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.woff2_src = IOSInput("è¯·æ‹–å…¥ TTF/OTF å­—ä½“", "font.ttf")
    main_window.woff2_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "webfont.woff2")
    btn = QPushButton("ğŸ“")
    btn.setFixedSize(40, 38)
    
    gd.addWidget(QLabel("æºå­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.woff2_src, btn), 0, 1)
    gd.addWidget(QLabel("è¾“å‡ºæ–‡ä»¶:"), 1, 0)
    gd.addWidget(main_window.woff2_out, 1, 1)
    l.addLayout(gd)

    info = QLabel(
        "<b>WOFF2 æ ¼å¼ç”¨é€”ï¼š</b><br>"
        "1. Web æ¸¸æˆ / H5 æ¸¸æˆ<br>"
        "2. åŸºäº Electron çš„æ¸¸æˆå¼•æ“<br>"
        "3. RPG Maker MZ ç­‰æ”¯æŒ WOFF2 çš„å¼•æ“<br>"
        "WOFF2 å…·æœ‰æé«˜çš„å‹ç¼©ç‡ï¼Œé€šå¸¸æ¯” TTF å° 40-70%"
    )
    info.setStyleSheet("background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 150%;")
    l.addWidget(info)
    l.addStretch()

    main_window.btn_run_woff2 = IOSButton("å¼€å§‹å‹ç¼©è½¬æ¢")
    main_window.btn_run_woff2.clicked.connect(main_window.do_gen_woff2)
    l.addWidget(main_window.btn_run_woff2)

def setup_cleanup_ui(main_window, parent_widget):
    l = QVBoxLayout(parent_widget)
    main_window.lbl_clean = QLabel("å…¼å®¹æ¸…ç†")
    main_window.lbl_clean.setAlignment(Qt.AlignmentFlag.AlignCenter)
    main_window.lbl_clean.setFont(QFont("Microsoft YaHei", 14, QFont.Weight.Bold))
    l.addWidget(main_window.lbl_clean)

    gd = QGridLayout()
    gd.setSpacing(10)
    main_window.clean_src = IOSInput("è¯·æ‹–å…¥å­—ä½“æ–‡ä»¶", "game.ttf")
    main_window.clean_out = IOSInput("è¾“å‡ºæ–‡ä»¶å", "game_clean.ttf")
    btn = QPushButton("ğŸ“")
    btn.setFixedSize(40, 38)
    
    gd.addWidget(QLabel("æºå­—ä½“:"), 0, 0)
    gd.addLayout(main_window.create_file_row(main_window.clean_src, btn), 0, 1)
    gd.addWidget(QLabel("è¾“å‡ºæ–‡ä»¶:"), 1, 0)
    gd.addWidget(main_window.clean_out, 1, 1)
    l.addLayout(gd)

    l.addWidget(QLabel("é€‰æ‹©è¦ç§»é™¤çš„è¡¨ (æé«˜è€å¼•æ“å…¼å®¹æ€§):"))
    
    main_window.chk_gsub = QCheckBox("ç§»é™¤ Ligatures (è¿å­—, GSUB)")
    main_window.chk_gpos = QCheckBox("ç§»é™¤ Kerning (å­—è·, GPOS)")
    main_window.chk_hdmx = QCheckBox("ç§»é™¤ Device Metrics (hdmx)")
    main_window.chk_vdmx = QCheckBox("ç§»é™¤ Vertical Device Metrics (VDMX)")
    main_window.chk_hint = QCheckBox("ç§»é™¤ Hinting (å¾®è°ƒæŒ‡ä»¤)")
    main_window.chk_name = QCheckBox("ç²¾ç®€ Name è¡¨ (ä»…ä¿ç•™æ ¸å¿ƒä¿¡æ¯)")
    
    config_layout = QGridLayout()
    config_layout.addWidget(main_window.chk_gsub, 0, 0)
    config_layout.addWidget(main_window.chk_gpos, 0, 1)
    config_layout.addWidget(main_window.chk_hdmx, 1, 0)
    config_layout.addWidget(main_window.chk_vdmx, 1, 1)
    config_layout.addWidget(main_window.chk_hint, 2, 0)
    config_layout.addWidget(main_window.chk_name, 2, 1)
    
    main_window.chk_gsub.setChecked(True)
    main_window.chk_gpos.setChecked(True)
    main_window.chk_hdmx.setChecked(True)
    main_window.chk_vdmx.setChecked(True)
    
    l.addLayout(config_layout)

    info = QLabel(
        "<b>ç”¨é€”ï¼š</b><br>"
        "é’ˆå¯¹æ— æ³•æ­£ç¡®è§£æå¤æ‚ OpenType ç‰¹æ€§çš„å¼•æ“ã€‚<br>"
        "è¡¨ç°ä¸ºï¼šæ¸¸æˆå´©æºƒã€æ–‡å­—é‡å ã€è¡Œè·å¼‚å¸¸ã€‚<br>"
        "ä½¿ç”¨æ­¤åŠŸèƒ½æ¸…ç†æ‰ä¸éœ€è¦çš„é«˜çº§è¡¨ï¼Œå¯ä»¥æ˜¾è‘—æé«˜å…¼å®¹æ€§å¹¶å‡å°ä½“ç§¯ã€‚"
    )
    info.setStyleSheet("background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 150%;")
    l.addWidget(info)
    l.addStretch()

    main_window.btn_run_clean = IOSButton("å¼€å§‹æ¸…ç†")
    main_window.btn_run_clean.clicked.connect(main_window.do_cleanup)
    l.addWidget(main_window.btn_run_clean)

def setup_preview_ui(main_window, parent_layout):
    line = QFrame()
    line.setFrameShape(QFrame.Shape.HLine)
    line.setStyleSheet("background: rgba(0,0,0,0.1);")
    parent_layout.addWidget(line)
    parent_layout.addSpacing(5)

    main_window.lbl_preview_title = main_window.create_label("æ•ˆæœé¢„è§ˆ")
    main_window.lbl_preview_title.setFont(QFont("Microsoft YaHei", 10, QFont.Weight.Bold))
    parent_layout.addWidget(main_window.lbl_preview_title)

    main_window.preview_input = IOSInput("è¾“å…¥é¢„è§ˆæ–‡æœ¬...", "æµ‹è¯•æ–‡æœ¬ Test 123")
    main_window.preview_input.setToolTip("è¾“å…¥æ‚¨æƒ³é¢„è§ˆçš„æ–‡æœ¬")
    main_window.preview_input.textChanged.connect(main_window.update_previews)
    main_window.preview_input.setFixedHeight(30)
    parent_layout.addWidget(main_window.preview_input)

    main_window.preview_area = QTextEdit("é¢„è§ˆ")
    main_window.preview_area.setReadOnly(True)
    main_window.preview_area.setFontPointSize(16)
    main_window.preview_area.setFixedHeight(70)
    main_window.preview_area.setToolTip("å­—ä½“é¢„è§ˆ")
    parent_layout.addWidget(main_window.preview_area)

    main_window.preview_labels = [main_window.lbl_preview_title]