# Galgame 字体工具 (GalFontTool)

一个专为 Galgame 汉化和字体适配设计的全能工具箱。集成了字体构建、精简、图片字库生成、字体度量修复以及文本映射等多种功能，帮助汉化组和开发者高效处理游戏字体问题。

## ✨ 主要功能

本工具包含四大核心模块：

### 1. 字体构建 (Font Builder)
- **多模式映射**：支持 CN -> JP (日繁映射)、JP -> CN (逆向映射)、仅伪装、简转繁、繁转简。
- **自动补全 (Fallback)**：支持指定“补全字体”，自动检测主字体缺失的字符并从补全字体中提取注入（自动缩放字形大小以匹配主字体）。
- **伪装模式**：修改字体元数据（CodePage），使其在游戏中伪装成日文字体（Shift-JIS 兼容）。
- **OpenCC 集成**：内置 OpenCC 支持高质量的简繁转换。

### 2. 字库精简 (Subsetter)
- **按需精简**：根据扫描的文本文件 (`.txt`, `.json`) 或映射表，仅保留使用到的字符。
- **体积压缩**：自动移除无用的 OpenType 表（如 EBDT, CBDT 等），显著减小字体体积。
- **Web 格式转换**：一键生成 WOFF2 格式，适合 Web Galgame 引擎。

### 3. 图片字库生成 (Bitmap Generator)
- **多格式支持**：
  - **BMFont**: 生成标准的 `.fnt` + `.png` 纹理图集 (Cocos2d, Unity 等常用)。
  - **TGA 引擎字库**: 生成特定引擎使用的 TGA 纹理及二进制索引文件 (`.txt` + `.tga`)。
  - **BMP 长图**: 生成垂直排列的 BMP 长图字库。
  - **Picture Font**: 生成分块的图片字库。
- **编码支持**: 专为 Shift-JIS (CP932) 范围优化，支持自动分包。

### 4. 字体修整 (Modifier)
- **度量修复 (Metrics Fix)**：一键修复 Ascent, Descent, LineGap，解决字体在游戏中垂直偏移或行距过大的问题。
- **字宽调整**：支持对字体进行几何缩放（长宽比）和全局字距（Spacing/Tracking）调整。
- **表清理**：移除 Hinting、详细名称表等冗余数据。

### 5. 文本映射 (Text Mapper)
- **智能映射生成**：扫描游戏脚本，将不在 Shift-JIS 范围内的汉字映射到 Shift-JIS 的空闲区（PUA 或未定义区域）。
- **文本替换**：根据生成的映射表，批量替换游戏脚本文件。
- **缺字检测**：分析文本需求，自动扫描本地字体库，推荐最佳的“补全字体”。

---

## 🛠️ 安装与运行

### 依赖环境
- Python 3.8+
- 建议使用虚拟环境

### 安装步骤
1. 克隆仓库：
   ```bash
   git clone https://github.com/your-repo/GalFontTool.git
   cd GalFontTool
   ```

2. 安装依赖：
   ```bash
   pip install PyQt6 fonttools pillow opencc-python-reimplemented brotli
   ```

3. 运行工具：
   ```bash
   python main.py
   ```

---

## 📖 详细使用说明

### 1. 字体构建 (Font Task)
用于生成最终的游戏字体文件。
- **源字体**: 选择你要使用的中文字体。
- **补全字体**: (可选) 选择一个字符集更大的字体（如 SimHei, Noto Sans SC）。当源字体缺字时，会自动从中提取。
- **映射表**: (可选) 配合“文本映射”模块生成的 JSON 文件使用。
- **模式选择**:
  - `日繁映射`: 将简体字映射到常用的 Shift-JIS 繁体码位。
  - `伪装模式`: 仅修改头文件信息，不改变字形，解决“乱码”或“字体不加载”问题。
  - `简繁转换`: 使用 OpenCC 进行字形转换。

### 2. 精简与转换 (Subset)
用于减小字体体积，适合发布。
- **输入**: 原始大体积字体。
- **扫描目录**: 指向解包后的游戏脚本目录 (`.txt`, `.json` 等)。
- **输出**: 仅包含脚本中出现过的字符的字体文件。

### 3. 图片字库 (Image Font)
针对使用图片作为字库的老游戏或特殊引擎。
- **BMFont**: 填写纹理尺寸 (如 2048x2048)，生成的 `.fnt` 可直接用于多种游戏引擎。
- **TGA/BMP**: 需根据具体游戏的引擎要求设置 `Block Size` (字块大小) 和 `Canvas Size` (画布大小)。

### 4. 高级修复 (Unified Fix)
解决字体显示异常。
- **缩放 (Scale X/Y)**: 如果游戏内字体显示过宽或过扁，可调整此参数 (如 X=0.9)。
- **间距 (Spacing)**: 调整字符左右的额外留白。
- **垂直度量 (Asc/Desc)**:
  - `Ascent`: 基线以上的高度。
  - `Descent`: 基线以下的深度 (通常为负值或正值，视引擎而定)。
  - `LineGap`: 行间距。
  - *提示*: 如果字体在游戏中偏上，尝试减小 Asc；如果偏下，尝试增大 Asc 或减小 Desc。

### 5. 智能缺字分析 (Fallback Scan)
帮助你找到最适合的“补全字体”。
1. 选择你的**主字体**和**游戏脚本目录**。
2. 设置**补全库目录** (放入你收集的各种大字符集字体)。
3. 点击扫描，工具会列出缺失的字符，并按覆盖率排名推荐补全字体。

---

## 🎨 主题配置

在 `config.py` 中可以修改 UI 主题。默认内置了多种配色方案：
- 🌊 Ocean (深海蓝)
- 🌸 Sakura (樱花粉)
- 🍃 Mint (薄荷绿)
- 🌙 Night (暗夜黑)
- 🍊 Sunset (日落橙)

---

## 📂 目录结构

```
GalFontTool/
├── core/
│   ├── tasks/
│   │   ├── font_tasks.py    # 字体构建/精简逻辑
│   │   ├── image_tasks.py   # 图片字库生成逻辑
│   │   ├── modify_tasks.py  # 字体修改/修复逻辑
│   │   └── text_tasks.py    # 文本扫描与映射逻辑
│   └── utils.py             # 通用工具函数
├── ui/                      # PyQt6 界面代码
├── config.py                # 配置文件
└── main.py                  # 程序入口
```

## ⚠️ 注意事项

- **版权**: 处理商业字体时请注意版权问题，生成的文件仅供个人学习或汉化补丁分发（需遵循原字体协议）。
- **备份**: 修改字体前建议备份原始文件。
- **OpenCC**: 如果遇到 OpenCC 导入错误，请确保安装了正确的包 `opencc-python-reimplemented`。

---

## 📝 贡献

欢迎提交 Issue 和 Pull Request 来完善此工具！
